services:
  teleflux:
    # Pull directly from GitHub Container Registry (GHCR).
    # NOTE: GHCR requires the repository path to be lowercase.
    image: ${TELEFLUX_IMAGE:-ghcr.io/weiyingiii/teleflux:latest}
    container_name: teleflux-bot
    restart: unless-stopped

    # Watchtower will only update containers with this label (safer on shared hosts).
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

    environment:
      # === REQUIRED: fill these three parameters ===
      API_ID: "${API_ID:-YOUR_API_ID}"
      API_HASH: "${API_HASH:-YOUR_API_HASH}"
      BOT_TOKEN: "${BOT_TOKEN:-YOUR_BOT_TOKEN}"

      # Optional
      TZ: "${TZ:-Asia/Shanghai}"

      # Optional: send a "bot started" message to these chat IDs (comma-separated)
      # Example: STARTUP_NOTIFY_CHAT_ID=123456789
      STARTUP_NOTIFY_CHAT_ID: "${STARTUP_NOTIFY_CHAT_ID:-}"

      # Optional: restrict management commands (/proxy, /concurrency) by user IDs (comma-separated)
      # Example: ADMIN_USER_IDS=123456789,987654321
      ADMIN_USER_IDS: "${ADMIN_USER_IDS:-}"

      # Optional: set proxy at startup (same format as /proxy)
      # Example: TELEFLUX_PROXY=socks5://user:pass@127.0.0.1:1080
      TELEFLUX_PROXY: "${TELEFLUX_PROXY:-}"

      # Tuning (optional)
      # Reduce concurrency if you see "File lives in another DC" then stuck at 0%
      MAX_CONCURRENT_DOWNLOADS: "${MAX_CONCURRENT_DOWNLOADS:-3}"
      # If no progress for N seconds, the task will be marked failed (helps avoid endless hangs)
      DOWNLOAD_STALL_TIMEOUT_S: "${DOWNLOAD_STALL_TIMEOUT_S:-180}"

      # Container internal paths (do not change unless you also change bot config)
      MUSIC_PATH: /data/Music
      VIDEO_PATH: /data/Video
      DOWNLOAD_PATH: /data/Download
      CACHE_PATH: /app/cache
      # Internal log file path (for /log command)
      LOG_DIR: /app/logs

    volumes:
      # Host directories. Defaults make the project runnable with only this YAML file.
      # You can replace these with your NAS paths (e.g. /vol2/1000/Music:/data/Music).
      - "${MUSIC_DIR:-./data/Music}:/data/Music"
      - "${VIDEO_DIR:-./data/Video}:/data/Video"
      - "${DOWNLOAD_DIR:-./data/Download}:/data/Download"

      # Keep cache persistent
      - "${CACHE_DIR:-./cache}:/app/cache"

      # Keep logs persistent (optional but recommended)
      - "${LOG_DIR_HOST:-./logs}:/app/logs"

  # Auto-updater: checks GHCR every minute for new images.
  # If an update is found, it will stop the old container and start a new one.
  # It will also delete the old container, anonymous volumes, and old images.
  watchtower:
    # NOTE: containrrr/watchtower has been archived and may not track newer Docker API changes.
    # This fork is widely used as a drop-in replacement.
    image: ${WATCHTOWER_IMAGE:-nickfedor/watchtower:latest}
    container_name: teleflux-watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command:
      - --interval
      - "60"
      - --cleanup
      - --remove-volumes
      - --label-enable
    # Optional: set your timezone for Watchtower logs
    environment:
      TZ: "${TZ:-Asia/Shanghai}"
      # Docker 29+ requires Docker API >= 1.44. Some Watchtower builds default to older API versions.
      # Set this explicitly to avoid errors like:
      #   "client version 1.25 is too old. Minimum supported API version is 1.44"
      DOCKER_API_VERSION: "${DOCKER_API_VERSION:-1.44}"
